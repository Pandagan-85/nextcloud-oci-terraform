#cloud-config
#
# Cloud-init configuration for Nextcloud instance
# Runs on first boot to setup system, Docker, and mount persistent storage
#

# Set timezone (UTC is recommended for servers)
timezone: UTC

# System updates
package_update: true
package_upgrade: true

# Install required packages
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades
  - git

# Create directory structure
runcmd:
  # ===========================================================================
  # SYSTEM CONFIGURATION
  # ===========================================================================

  - echo "=== Starting cloud-init setup ==="

  # Update DuckDNS
  - echo "=== Updating DuckDNS ==="
  - curl "https://www.duckdns.org/update?domains=${duckdns_domain}&token=${duckdns_token}&ip="

  # ===========================================================================
  # FIREWALL CONFIGURATION (UFW)
  # ===========================================================================

  - echo "=== Configuring UFW firewall ==="
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment 'SSH'
  - ufw allow 80/tcp comment 'HTTP'
  - ufw allow 443/tcp comment 'HTTPS'
  - ufw allow 443/udp comment 'HTTP/3'
  - ufw allow 8080/tcp comment 'Nextcloud AIO'
  - ufw allow 8443/tcp comment 'Nextcloud AIO HTTPS'
  - ufw --force enable

  # ===========================================================================
  # FAIL2BAN CONFIGURATION
  # ===========================================================================

  - echo "=== Configuring Fail2ban ==="
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # ===========================================================================
  # DOCKER INSTALLATION
  # ===========================================================================

  - echo "=== Installing Docker ==="

  # Add Docker's official GPG key
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

  # Add Docker repository (ARM64)
  - echo "deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

  # Install Docker
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Start Docker
  - systemctl enable docker
  - systemctl start docker

  # Add ubuntu user to docker group
  - usermod -aG docker ubuntu

  # ===========================================================================
  # PERSISTENT STORAGE SETUP
  # ===========================================================================

  - echo "=== Setting up persistent storage ==="

  # Wait for block volume to be attached
  - while [ ! -e /dev/oracleoci/oraclevdb ]; do echo "Waiting for data volume..."; sleep 5; done

  # Check if volume is formatted
  - |
    if ! blkid /dev/oracleoci/oraclevdb; then
      echo "=== Formatting data volume ==="
      mkfs.ext4 -L nextcloud-data /dev/oracleoci/oraclevdb
    else
      echo "=== Data volume already formatted ==="
    fi

  # Create mount point
  - mkdir -p /mnt/nextcloud-data

  # Mount volume
  - mount /dev/oracleoci/oraclevdb /mnt/nextcloud-data

  # Add to fstab for persistence
  - echo "LABEL=nextcloud-data /mnt/nextcloud-data ext4 defaults,nofail 0 2" >> /etc/fstab

  # ===========================================================================
  # PERSISTENT STORAGE FOR BACKUPS
  # ===========================================================================

  - echo "=== Setting up persistent storage for backups ==="

  # Create directories on persistent volume (150GB)
  # - nextcloud-data: Nextcloud files, database, config (NEXTCLOUD_DATADIR)
  # - borg-backups: Encrypted Borg backup repository
  # - exports: Human-readable backup exports
  - mkdir -p /mnt/nextcloud-data/nextcloud-data
  - mkdir -p /mnt/nextcloud-data/borg-backups
  - mkdir -p /mnt/nextcloud-data/exports
  - chown -R ubuntu:ubuntu /mnt/nextcloud-data

  # Configure Docker logging (but keep default data-root)
  - mkdir -p /etc/docker
  - |
    cat > /etc/docker/daemon.json <<EOF
    {
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m",
        "max-file": "3"
      }
    }
    EOF

  # ===========================================================================
  # NEXTCLOUD PREPARATION
  # ===========================================================================

  - echo "=== Preparing Nextcloud directories ==="

  # Create nextcloud directory in ubuntu home
  - mkdir -p /home/ubuntu/nextcloud

  # Fix ownership for files created in write_files (ubuntu user exists now)
  - chown ubuntu:ubuntu /home/ubuntu/system-info.sh
  - chown -R ubuntu:ubuntu /home/ubuntu/nextcloud

  # ===========================================================================
  # UNATTENDED UPGRADES
  # ===========================================================================

  - echo "=== Configuring automatic security updates ==="
  - |
    cat > /etc/apt/apt.conf.d/50unattended-upgrades <<EOF
    Unattended-Upgrade::Allowed-Origins {
        "$${distro_id}:$${distro_codename}-security";
        "$${distro_id}ESMApps:$${distro_codename}-apps-security";
        "$${distro_id}ESM:$${distro_codename}-infra-security";
    };
    Unattended-Upgrade::AutoFixInterruptedDpkg "true";
    Unattended-Upgrade::MinimalSteps "true";
    Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";
    Unattended-Upgrade::Automatic-Reboot "false";
    EOF

  # ===========================================================================
  # NEXTCLOUD AIO DEPLOYMENT
  # ===========================================================================

  - echo "=== Deploying Nextcloud AIO + Caddy ==="

  # Deploy containers
  # NOTE: At first boot, this creates fresh containers
  # After backup/restore via AIO interface, data persists in Docker volumes
  - cd /home/ubuntu/nextcloud && docker compose up -d
  - echo "=== Nextcloud AIO deployed ==="

  # ===========================================================================
  # COMPLETION
  # ===========================================================================

  - echo "=== Cloud-init setup complete ==="
  - echo "=== Nextcloud instance fully automated and ready! ==="

# Write files
write_files:
  # DuckDNS update script
  - path: /usr/local/bin/duckdns-update.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      curl "https://www.duckdns.org/update?domains=${duckdns_domain}&token=${duckdns_token}&ip="

  # System info script
  - path: /home/ubuntu/system-info.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      echo "=== Nextcloud Instance Info ==="
      echo "Hostname: $(hostname)"
      echo "Public IP: $(curl -s ifconfig.me)"
      echo "DuckDNS: ${duckdns_domain}.duckdns.org"
      echo "Docker: $(docker --version)"
      echo "Docker Compose: $(docker compose version)"
      echo "Data Volume: $(df -h /mnt/nextcloud-data | tail -1)"
      echo "==========================="

  # Nextcloud AIO + Caddy docker-compose.yml
  - path: /home/ubuntu/nextcloud/docker-compose.yml
    permissions: "0644"
    content: |
      services:
        nextcloud-aio-mastercontainer:
          image: nextcloud/all-in-one:latest
          container_name: nextcloud-aio-mastercontainer
          restart: always
          ports:
            - "8080:8080"
            - "8443:8443"
          environment:
            - APACHE_PORT=11000
            - APACHE_IP_BINDING=0.0.0.0
            - SKIP_DOMAIN_VALIDATION=true
            - TZ=UTC
            - NEXTCLOUD_DATADIR=/mnt/nextcloud-data/nextcloud-data
            - BORG_BACKUP_HOST_LOCATION=/mnt/nextcloud-data/borg-backups
          volumes:
            - nextcloud_aio_mastercontainer:/mnt/docker-aio-config
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - /mnt/nextcloud-data:/mnt/nextcloud-data:rw
          networks:
            - nextcloud-aio

        caddy:
          image: caddy:latest
          container_name: caddy-reverse-proxy
          restart: always
          ports:
            - "80:80"
            - "443:443"
            - "443:443/udp"
          volumes:
            - ./Caddyfile:/etc/caddy/Caddyfile
            - caddy_data:/data
            - caddy_config:/config
          networks:
            - nextcloud-aio
          depends_on:
            - nextcloud-aio-mastercontainer

      networks:
        nextcloud-aio:
          name: nextcloud-aio

      volumes:
        nextcloud_aio_mastercontainer:
          name: nextcloud_aio_mastercontainer
        caddy_data:
        caddy_config:

  # Caddyfile for reverse proxy
  - path: /home/ubuntu/nextcloud/Caddyfile
    permissions: "0644"
    content: |
      ${duckdns_domain}.duckdns.org {
          reverse_proxy nextcloud-aio-apache:11000

          header {
              Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
              X-Frame-Options "SAMEORIGIN"
              X-Content-Type-Options "nosniff"
              X-XSS-Protection "1; mode=block"
              Referrer-Policy "no-referrer"
          }

          encode gzip

          log {
              output file /data/access.log
              level INFO
          }
      }

# Final message
final_message: |
  ================================================================
  Nextcloud instance is FULLY AUTOMATED and ready!

  Instance: ${app_name}
  Domain: ${duckdns_domain}.duckdns.org

  âœ… Docker installed and configured
  âœ… Persistent storage mounted (/mnt/nextcloud-data)
  âœ… Nextcloud AIO deployed automatically
  âœ… Caddy reverse proxy configured
  âœ… Firewall (UFW) enabled
  âœ… Fail2ban active

  Access AIO interface:
  - https://<public-ip>:8080

  Access Nextcloud (after AIO setup):
  - https://${duckdns_domain}.duckdns.org

  SSH: ssh ubuntu@<public-ip>

  All data persisted on: /mnt/nextcloud-data

  This instance is 100% Infrastructure as Code! ðŸš€
  ================================================================
