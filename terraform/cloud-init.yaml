#cloud-config
#
# Cloud-init configuration for Nextcloud instance
# Runs on first boot to setup system, Docker, and mount persistent storage
#

# Set timezone
timezone: Europe/Rome

# System updates
package_update: true
package_upgrade: true

# Install required packages
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades
  - git

# Create directory structure
runcmd:
  # ===========================================================================
  # SYSTEM CONFIGURATION
  # ===========================================================================

  - echo "=== Starting cloud-init setup ==="

  # Update DuckDNS
  - echo "=== Updating DuckDNS ==="
  - curl "https://www.duckdns.org/update?domains=${duckdns_domain}&token=${duckdns_token}&ip="

  # ===========================================================================
  # FIREWALL CONFIGURATION (UFW)
  # ===========================================================================

  - echo "=== Configuring UFW firewall ==="
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment 'SSH'
  - ufw allow 80/tcp comment 'HTTP'
  - ufw allow 443/tcp comment 'HTTPS'
  - ufw allow 443/udp comment 'HTTP/3'
  - ufw allow 8080/tcp comment 'Nextcloud AIO'
  - ufw allow 8443/tcp comment 'Nextcloud AIO HTTPS'
  - ufw --force enable

  # ===========================================================================
  # FAIL2BAN CONFIGURATION
  # ===========================================================================

  - echo "=== Configuring Fail2ban ==="
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # ===========================================================================
  # DOCKER INSTALLATION
  # ===========================================================================

  - echo "=== Installing Docker ==="

  # Add Docker's official GPG key
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

  # Add Docker repository (ARM64)
  - echo "deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

  # Install Docker
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Start Docker
  - systemctl enable docker
  - systemctl start docker

  # Add ubuntu user to docker group
  - usermod -aG docker ubuntu

  # ===========================================================================
  # PERSISTENT STORAGE SETUP
  # ===========================================================================

  - echo "=== Setting up persistent storage ==="

  # Wait for block volume to be attached
  - while [ ! -e /dev/oracleoci/oraclevdb ]; do echo "Waiting for data volume..."; sleep 5; done

  # Check if volume is formatted
  - |
    if ! blkid /dev/oracleoci/oraclevdb; then
      echo "=== Formatting data volume ==="
      mkfs.ext4 -L nextcloud-data /dev/oracleoci/oraclevdb
    else
      echo "=== Data volume already formatted ==="
    fi

  # Create mount point
  - mkdir -p /mnt/nextcloud-data

  # Mount volume
  - mount /dev/oracleoci/oraclevdb /mnt/nextcloud-data

  # Add to fstab for persistence
  - echo "LABEL=nextcloud-data /mnt/nextcloud-data ext4 defaults,nofail 0 2" >> /etc/fstab

  # Set ownership
  - chown -R ubuntu:ubuntu /mnt/nextcloud-data

  # ===========================================================================
  # DOCKER VOLUMES SETUP
  # ===========================================================================

  - echo "=== Setting up Docker volume directories ==="

  # Stop Docker to move default volume location
  - systemctl stop docker

  # Create directories on persistent storage
  - mkdir -p /mnt/nextcloud-data/docker-volumes
  - mkdir -p /mnt/nextcloud-data/borg-backups
  - mkdir -p /mnt/nextcloud-data/exports

  # Configure Docker to use persistent storage for volumes
  - mkdir -p /etc/docker
  - |
    cat > /etc/docker/daemon.json <<EOF
    {
      "data-root": "/mnt/nextcloud-data/docker-volumes",
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m",
        "max-file": "3"
      }
    }
    EOF

  # Start Docker
  - systemctl start docker

  # ===========================================================================
  # NEXTCLOUD PREPARATION
  # ===========================================================================

  - echo "=== Preparing Nextcloud directories ==="

  # Create nextcloud directory in ubuntu home
  - mkdir -p /home/ubuntu/nextcloud
  - chown -R ubuntu:ubuntu /home/ubuntu/nextcloud

  # ===========================================================================
  # UNATTENDED UPGRADES
  # ===========================================================================

  - echo "=== Configuring automatic security updates ==="
  - |
    cat > /etc/apt/apt.conf.d/50unattended-upgrades <<EOF
    Unattended-Upgrade::Allowed-Origins {
        "$${distro_id}:$${distro_codename}-security";
        "$${distro_id}ESMApps:$${distro_codename}-apps-security";
        "$${distro_id}ESM:$${distro_codename}-infra-security";
    };
    Unattended-Upgrade::AutoFixInterruptedDpkg "true";
    Unattended-Upgrade::MinimalSteps "true";
    Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";
    Unattended-Upgrade::Automatic-Reboot "false";
    EOF

  # ===========================================================================
  # COMPLETION
  # ===========================================================================

  - echo "=== Cloud-init setup complete ==="
  - echo "=== System ready for Nextcloud deployment ==="

# Write files
write_files:
  # DuckDNS update script
  - path: /usr/local/bin/duckdns-update.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      curl "https://www.duckdns.org/update?domains=${duckdns_domain}&token=${duckdns_token}&ip="

  # System info script
  - path: /home/ubuntu/system-info.sh
    permissions: "0755"
    owner: ubuntu:ubuntu
    content: |
      #!/bin/bash
      echo "=== Nextcloud Instance Info ==="
      echo "Hostname: $(hostname)"
      echo "Public IP: $(curl -s ifconfig.me)"
      echo "DuckDNS: ${duckdns_domain}.duckdns.org"
      echo "Docker: $(docker --version)"
      echo "Docker Compose: $(docker compose version)"
      echo "Data Volume: $(df -h /mnt/nextcloud-data | tail -1)"
      echo "==========================="

# Final message
final_message: |
  ================================================================
  Nextcloud instance is ready!

  Instance: ${app_name}
  DuckDNS: ${duckdns_domain}.duckdns.org

  Next steps:
  1. SSH to the instance: ssh ubuntu@<public-ip>
  2. Deploy Nextcloud: cd ~/nextcloud && docker compose up -d
  3. Access AIO: https://<public-ip>:8080

  Data is persisted on: /mnt/nextcloud-data
  ================================================================
