#cloud-config
#
# Cloud-init configuration for Nextcloud instance
# Runs on first boot to setup system, Docker, and mount persistent storage
#

# Set timezone (UTC is recommended for servers)
timezone: UTC

# System updates
package_update: true
package_upgrade: true

# Install required packages
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades
  - git

# Create directory structure
runcmd:
  # ===========================================================================
  # SYSTEM CONFIGURATION
  # ===========================================================================

  - echo "=== Starting cloud-init setup ==="

  # Update DuckDNS
  - echo "=== Updating DuckDNS ==="
  - curl "https://www.duckdns.org/update?domains=${duckdns_domain}&token=${duckdns_token}&ip="

  # ===========================================================================
  # FIREWALL CONFIGURATION (UFW)
  # ===========================================================================

  - echo "=== Configuring UFW firewall ==="
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment 'SSH'
  - ufw allow 80/tcp comment 'HTTP'
  - ufw allow 443/tcp comment 'HTTPS'
  - ufw allow 443/udp comment 'HTTP/3'
  - ufw allow 8080/tcp comment 'Nextcloud AIO'
  - ufw allow 8443/tcp comment 'Nextcloud AIO HTTPS'
  - ufw --force enable

  # ===========================================================================
  # FAIL2BAN CONFIGURATION
  # ===========================================================================

  - echo "=== Configuring Fail2ban ==="
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # ===========================================================================
  # DOCKER INSTALLATION
  # ===========================================================================

  - echo "=== Installing Docker ==="

  # Add Docker's official GPG key
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

  # Add Docker repository (ARM64)
  - echo "deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

  # Install Docker
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Start Docker
  - systemctl enable docker
  - systemctl start docker

  # Add ubuntu user to docker group
  - usermod -aG docker ubuntu

  # ===========================================================================
  # PERSISTENT STORAGE SETUP
  # ===========================================================================

  - echo "=== Setting up persistent storage ==="

  # Wait for block volume to be attached
  - while [ ! -e /dev/oracleoci/oraclevdb ]; do echo "Waiting for data volume..."; sleep 5; done

  # Check if volume is formatted
  - |
    if ! blkid /dev/oracleoci/oraclevdb; then
      echo "=== Formatting data volume ==="
      mkfs.ext4 -L nextcloud-data /dev/oracleoci/oraclevdb
    else
      echo "=== Data volume already formatted ==="
    fi

  # Create mount point
  - mkdir -p /mnt/nextcloud-data

  # Mount volume
  - mount /dev/oracleoci/oraclevdb /mnt/nextcloud-data

  # Add to fstab for persistence
  - echo "LABEL=nextcloud-data /mnt/nextcloud-data ext4 defaults,nofail 0 2" >> /etc/fstab

  # ===========================================================================
  # PERSISTENT STORAGE FOR BACKUPS
  # ===========================================================================

  - echo "=== Setting up persistent storage for backups ==="

  # Create directories on persistent volume (150GB)
  # - nextcloud-data: Nextcloud files, database, config (NEXTCLOUD_DATADIR)
  # - borg-backups: Encrypted Borg backup repository
  # - exports: Human-readable backup exports
  - mkdir -p /mnt/nextcloud-data/nextcloud-data
  - mkdir -p /mnt/nextcloud-data/borg-backups
  - mkdir -p /mnt/nextcloud-data/exports
  - chown -R ubuntu:ubuntu /mnt/nextcloud-data

  # Configure Docker logging (but keep default data-root)
  - mkdir -p /etc/docker
  - |
    cat > /etc/docker/daemon.json <<EOF
    {
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m",
        "max-file": "3"
      }
    }
    EOF

  # ===========================================================================
  # REPOSITORY CLONE & NEXTCLOUD PREPARATION
  # ===========================================================================

  - echo "=== Cloning Nextcloud configuration repository ==="

  # Clone the repository with all configuration files
  - cd /home/ubuntu
  - git clone https://github.com/Pandagan-85/nextcloud-oci-terraform.git repo-temp

  # Create nextcloud directory and copy files
  - mkdir -p /home/ubuntu/nextcloud
  - cp repo-temp/docker/docker-compose.yml /home/ubuntu/nextcloud/
  - cp repo-temp/docker/Caddyfile.template /home/ubuntu/nextcloud/Caddyfile || cp repo-temp/docker/Caddyfile /home/ubuntu/nextcloud/
  - cp -r repo-temp/docker/monitoring /home/ubuntu/nextcloud/ 2>/dev/null || true
  # Generate Caddyfile with correct domain (replace YOUR_DOMAIN placeholder)
  - sed -i "s/YOUR_DOMAIN/${duckdns_domain}/g" /home/ubuntu/nextcloud/Caddyfile

  # Fix ownership
  - chown ubuntu:ubuntu /home/ubuntu/system-info.sh
  - chown -R ubuntu:ubuntu /home/ubuntu/nextcloud

  # Cleanup temp repo
  - rm -rf /home/ubuntu/repo-temp

  # Create .env file with instructions (secrets must be set manually)
  - |
    cat > /home/ubuntu/nextcloud/.env <<'ENVEOF'
    # ==============================================================================
    # NEXTCLOUD + MONITORING ENVIRONMENT VARIABLES
    # ==============================================================================
    #
    # IMPORTANT: Set these passwords manually after first boot!
    #
    # To set Grafana password:
    #   GRAFANA_ADMIN_PASSWORD=$(openssl rand -base64 32)
    #   echo "GRAFANA_ADMIN_PASSWORD=$GRAFANA_ADMIN_PASSWORD" >> /home/ubuntu/nextcloud/.env
    #
    # Grafana will be accessible at: https://monitoring.${duckdns_domain}.duckdns.org
    # Default username: admin
    #
    # ==============================================================================

    # GRAFANA_ADMIN_PASSWORD=CHANGEME-RUN-COMMAND-ABOVE
    ENVEOF

  - chown ubuntu:ubuntu /home/ubuntu/nextcloud/.env

  # ===========================================================================
  # UNATTENDED UPGRADES
  # ===========================================================================

  - echo "=== Configuring automatic security updates ==="
  - |
    cat > /etc/apt/apt.conf.d/50unattended-upgrades <<EOF
    Unattended-Upgrade::Allowed-Origins {
        "$${distro_id}:$${distro_codename}-security";
        "$${distro_id}ESMApps:$${distro_codename}-apps-security";
        "$${distro_id}ESM:$${distro_codename}-infra-security";
    };
    Unattended-Upgrade::AutoFixInterruptedDpkg "true";
    Unattended-Upgrade::MinimalSteps "true";
    Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";
    Unattended-Upgrade::Automatic-Reboot "false";
    EOF

  # ===========================================================================
  # NEXTCLOUD AIO DEPLOYMENT
  # ===========================================================================

  - echo "=== Deploying Nextcloud AIO + Caddy ==="

  # Deploy containers
  # NOTE: At first boot, this creates fresh containers
  # After backup/restore via AIO interface, data persists in Docker volumes
  - cd /home/ubuntu/nextcloud && docker compose up -d
  - echo "=== Nextcloud AIO deployed ==="

  # ===========================================================================
  # COMPLETION
  # ===========================================================================

  - echo "=== Cloud-init setup complete ==="
  - echo "=== Nextcloud instance fully automated and ready! ==="

# Write files
write_files:
  # DuckDNS update script
  - path: /usr/local/bin/duckdns-update.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      curl "https://www.duckdns.org/update?domains=${duckdns_domain}&token=${duckdns_token}&ip="

  # System info script
  - path: /home/ubuntu/system-info.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      echo "=== Nextcloud Instance Info ==="
      echo "Hostname: $(hostname)"
      echo "Public IP: $(curl -s ifconfig.me)"
      echo "DuckDNS: ${duckdns_domain}.duckdns.org"
      echo "Docker: $(docker --version)"
      echo "Docker Compose: $(docker compose version)"
      echo "Data Volume: $(df -h /mnt/nextcloud-data | tail -1)"
      echo "==========================="

  # Setup reminder for post-deployment configuration
  - path: /home/ubuntu/SETUP-NEXTCLOUD.txt
    permissions: "0644"
    content: |
      ================================================================
      ðŸŽ‰ Nextcloud Infrastructure Deployed Successfully!
      ================================================================

      âš ï¸  IMPORTANT: Manual Configuration Required

      1. Set Grafana Admin Password:
         cd /home/ubuntu/nextcloud
         GRAFANA_ADMIN_PASSWORD=$(openssl rand -base64 32)
         echo "GRAFANA_ADMIN_PASSWORD=$GRAFANA_ADMIN_PASSWORD" >> .env
         echo "Your Grafana password: $GRAFANA_ADMIN_PASSWORD"

      2. Restart Grafana to apply password:
         docker compose restart grafana

      3. Access Services:
         - Nextcloud AIO Setup: https://${duckdns_domain}.duckdns.org:8080
         - Nextcloud (after AIO setup): https://${duckdns_domain}.duckdns.org
         - Grafana Monitoring: https://monitoring.${duckdns_domain}.duckdns.org
           Username: admin
           Password: (from step 1)

      4. Nextcloud Initial Setup:
         - Access AIO interface on port 8080
         - Complete setup wizard
         - Configure which containers to run (Talk, Collabora, etc.)
         - Set admin password

      5. Monitoring Dashboards (Grafana):
         - Import Dashboard ID 179: Docker Container Metrics
         - Import Dashboard ID 11074: Node Exporter System Metrics

      ðŸ“‚ All configuration files: /home/ubuntu/nextcloud/
      ðŸ“Š Monitoring stack: Prometheus + Grafana + cAdvisor + Node Exporter
      ðŸ’¾ Persistent data: /mnt/nextcloud-data/

      ================================================================

# Final message
final_message: |
  ================================================================
  ðŸš€ Nextcloud Infrastructure Successfully Deployed!
  ================================================================

  Instance: ${app_name}
  Domain: ${duckdns_domain}.duckdns.org

  âœ… Docker installed and configured
  âœ… Persistent storage mounted (/mnt/nextcloud-data)
  âœ… Nextcloud AIO deployed (with monitoring stack!)
  âœ… Caddy reverse proxy configured
  âœ… Prometheus + Grafana monitoring ready
  âœ… Firewall (UFW) enabled
  âœ… Fail2ban active

  ðŸ“‹ NEXT STEPS (Manual Configuration Required):

  Read detailed instructions:
  cat /home/ubuntu/SETUP-NEXTCLOUD.txt

  Quick Start:
  1. SSH: ssh ubuntu@<public-ip>
  2. Set Grafana password (see SETUP-NEXTCLOUD.txt)
  3. Access Nextcloud AIO: https://<public-ip>:8080
  4. Complete Nextcloud setup wizard

  Access URLs:
  - Nextcloud (after setup): https://${duckdns_domain}.duckdns.org
  - Grafana Monitoring: https://monitoring.${duckdns_domain}.duckdns.org

  All data persisted: /mnt/nextcloud-data
  Configuration from: GitHub repo (always up-to-date!)

  This instance is 100% Infrastructure as Code! ðŸŽ‰
  ================================================================
